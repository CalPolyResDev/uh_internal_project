{% extends "base.html" %}
{% load staticfiles %}

{% block subtitle %} | Email{% endblock %}

{% block meta %}
{{ block.super }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<style>
.button.default {
    padding: 6px 12px !important;
}
</style>
{% endblock %}

{% block content %}
    <div id="content">
        <h1>ResNet Email Messages</h1>
        <table>
            <tr>
                <td style="vertical-align: top;">
                    <div id="jstree_folder_structure"></div>
                </td>
                <td style="vertical-align: top; width: 75%;">
                    <div>
                        <button class="button default" onclick="$.fancybox({href : '{% url 'email_compose' %}', 
                                                                            title : 'New Message', 
                                                                            type: 'iframe', 
                                                                            maxWidth: '85%', 
                                                                            width: 1000}); 
                                                                $.fancybox.showLoading();">
                            New Message
                        </button>
                        <button class="button default" onclick="$('input:checkbox').prop('checked', true);">Check All</button>
                        <button class="button default" onclick="$('input:checkbox').prop('checked', false);">Uncheck All</button>
                        <button class="button default" onclick="refresh_messages('INBOX');" id="refresh_button">Refresh</button>
                        <button class="button default" id="archive_button" title="Archive To:" data-container="body" data-toggle="popover" data-placement="bottom" 
                            data-content="<table class='dataTable'>
                                    <tbody>
                                        {% for folder, display_name in archive_folders %}
                                            <tr id='{{ folder }}' style='cursor: pointer;' onclick='$(&quot;#archive_button&quot;).popover(&quot;hide&quot;);archive_selected(&quot;{{ folder }}&quot;);'>
                                                <td>{{ display_name }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>">
                            Archive
                        </button>
                        <button class="button default" onclick="mark_selected_unread();">Mark as Unread</button>
                        <button class="button default" onclick="mark_selected_read();">Mark as Read</button>
                    </div>
                    <table class="dataTable" id='email_table' style="">
                    <tbody>
                            <tr>
                                <th></th>
                                <th></th>
                                <th>Date</th>
                                <th id="sender_header">From</th>
                                <th>Subject</th>
                            </tr>
                            <tr id="loading_email_record"><td colspan="5" style="text-align: center;"><br /><strong>Loading...</strong></td></tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block extra_script %}
{{ block.super }}
<script type="text/javascript">
    $(document).ready(function() {
            $('#jstree_folder_structure')
            .on('select_node.jstree', function(event, data) {
                refresh_messages(data.node.id);
            })
            .jstree({
                'core': {
                    'data': {
                        'url': "{% url 'email_get_folders' %}",
                        'data': function(node) {
                            return { 'id': node.text };
                        }
                    }
                }
            });
            refresh_messages('INBOX');
    });

    function get_selected_emails() {
        var rows = new Array();
        $('#email_table tr').filter(':has(:checkbox:checked)').each(function() {
            rows.push(this.id);
        });

        return rows;
    };

    function set_spinner_status(emails, status) {
        for (index = 0; index < emails.length; ++index) {
            var checkbox = document.getElementById('checkbox_' + emails[index]);
            checkbox.style.display = status ? 'none' : 'inline';
            
            var spinner = document.getElementById('spinner_' + emails[index]); 
            spinner.style.display = status ? 'inline' : 'none';
        };
    };

    function refresh_messages(mailbox) {
        $("#email_table tr:gt(0)").remove();
        $("#email_table").append('<tr id="loading_email_record"><td colspan="5" style="text-align: center;"><br /><strong>Loading...</strong></td></tr>');
        ajaxPost("{% url 'email_get_mailbox_summary' %}", {"mailbox": mailbox}, function(response_context) {
            $("#refresh_button").attr("onclick","refresh_messages('" + mailbox + "');");
        });
        
        if (mailbox === 'Sent Items') {
            $('#sender_header').text('To');
        }
        else {
            $('#sender_header').text('From');
        }
    };

    function array_to_ajax(array, prefix) {
        var ajax_dict = {};
        for (index = 0; index < array.length; ++index) {
            ajax_dict[prefix + index.toString()] = array[index];
        };

        return ajax_dict;
    };

    function archive_selected(destination_folder) {
        var selected_messages = get_selected_emails();
        set_spinner_status(selected_messages, true);

        var post_data = array_to_ajax(selected_messages, 'message');
        post_data['destination_folder'] = destination_folder;

        ajaxPost("{% url 'email_archive' %}", post_data, function(response_context) {
            for (index = 0; index < selected_messages.length; ++index) {
                $(document.getElementById(selected_messages[index])).remove();
            };  
        });
    };

    function mark_selected_unread() {
        var selected_messages = get_selected_emails();
        set_spinner_status(selected_messages, true);
        ajaxPost("{% url 'email_mark_unread' %}", array_to_ajax(selected_messages, 'message'), function(response_context) {
            for (index = 0; index < selected_messages.length; ++index) {
                $(document.getElementById(selected_messages[index])).addClass('bg-info');
            };
            set_spinner_status(selected_messages, false);
        });
    };

    function mark_selected_read() {
        var selected_messages = get_selected_emails();
        set_spinner_status(selected_messages, true);
        ajaxPost("{% url 'email_mark_read' %}", array_to_ajax(selected_messages, 'message'), function(response_context) {
            for (index = 0; index < selected_messages.length; ++index) {
                $(document.getElementById(selected_messages[index])).removeClass('bg-info');
            };
            set_spinner_status(selected_messages, false);
        });
    };

    function remove_voicemail(message_uid)  {
        // Cannot use JQuery here: $ signs and other character in UUID break the query
        var archive_link = document.getElementById('archive_' + message_uid);
        archive_link.style.display = 'none';
        
        var spinner = document.getElementById('spinner_' + message_uid);
        spinner.style.display = 'block';
        
        ajaxPost("{% url 'remove_voicemail' %}", {"message_uid": message_uid}, function(response_context) {
            var row = document.getElementById('voicemail_' + message_uid);
            row.parentNode.removeChild(row);
        });
    };
</script>
{% endblock %}