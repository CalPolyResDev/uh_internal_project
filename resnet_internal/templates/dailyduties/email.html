{% extends "base.html" %}
{% load core_user_tests %}
{% load staticfiles %}

{% block subtitle %} | Email{% endblock %}

{% block meta %}
<script src="{% static 'js/jstree.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/jstree.css' %}" />
{% endblock %}

{% block content %}
    <div id="content">
        <h1>ResNet Email Messages</h1>
        <table>
            <tr>
                <td style="vertical-align: top;">
                    <div id="jstree_folder_structure"></div>
                </td>
                <td style="vertical-align: top; width: 75%;">
                    <div>
                        <button style="padding: 6px 12px;" class="button default" onclick="$('input:checkbox').prop('checked', true);">Check All</button>
                        <button style="padding: 6px 12px;" class="button default" onclick="$('input:checkbox').prop('checked', false);">Uncheck All</button>
                        <button style="padding: 6px 12px;" class="button default" onclick="refresh_messages('INBOX');" id="refresh_button">Refresh</button>
                        <button style="padding: 6px 12px;" class="button default" onclick="archive_selected();">Archive</button>
                        <button style="padding: 6px 12px;" class="button default" onclick="mark_selected_unread();">Mark as Unread</button>
                        <button style="padding: 6px 12px;" class="button default" onclick="mark_selected_read();">Mark as Read</button>
                    </div>
                    <table class="dataTable" id='email_table' style="">
                    <tbody>
                            <tr>
                                <th></th>
                                <th>Date</th>
                                <th>From</th>
                                <th>Subject</th>
                            </tr>
                            <tr id="loading_email_record"><td colspan="4" style="text-align: center;"><br /><strong>Loading...</strong></td></tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </table>
    </div>
{% endblock %}

{% block extra_script %}
{{ block.super }}
<script type="text/javascript">
    $(document).ready(function() {
            $('#jstree_folder_structure')
            .on('select_node.jstree', function(event, data) {
                refresh_messages(data.node.id);
            })
            .jstree({
                'core': {
                    'data': {
                        'url': "{% url 'email_get_folders' %}",
                        'data': function(node) {
                            return { 'id': node.text };
                        }
                    }
                }
            });
            refresh_messages('INBOX');
    });
    function get_selected_emails() {
        var rows = new Array();
        $('#email_table tr').filter(':has(:checkbox:checked)').each(function() {
            rows.push(this.id);
        });

        return rows;
    };
    function set_spinner_status(emails, status) {
        for (index = 0; index < emails.length; ++index) {
            var checkbox = document.getElementById('checkbox_' + emails[index]);
            checkbox.style.display = status ? 'none' : 'inline';
            
            var spinner = document.getElementById('spinner_' + emails[index]); 
            spinner.style.display = status ? 'inline' : 'none';
        };
    };
    function refresh_messages(mailbox) {
        $("#email_table tr:gt(0)").remove();
        $("#email_table").append('<tr id="loading_email_record"><td colspan="4" style="text-align: center;"><br /><strong>Loading...</strong></td></tr>');
        ajaxPost("{% url 'email_get_mailbox_summary' %}", {"mailbox": mailbox}, function(response_context) {
            $("#refresh_button").attr("onclick","refresh_messages('" + mailbox + "');");
        });
    };
    function arrayToAjax(array, prefix) {
        var ajaxDict = {};
        for (index = 0; index < array.length; ++index) {
            ajaxDict[prefix + index.toString()] = array[index];
        };

        return ajaxDict;
    };
    function archive_selected() {
        var selected_messages = get_selected_emails();
    };
    function mark_selected_unread() {
        var selected_messages = get_selected_emails();
        set_spinner_status(selected_messages, true);
        ajaxPost("{% url 'email_mark_unread' %}", arrayToAjax(selected_messages, 'message'), function(response_context) {
            for (index = 0; index < selected_messages.length; ++index) {
                $(document.getElementById(selected_messages[index])).addClass('bg-info');
            };
            set_spinner_status(selected_messages, false);
        });
    };
    function mark_selected_read() {
        var selected_messages = get_selected_emails();
        set_spinner_status(selected_messages, true);
        ajaxPost("{% url 'email_mark_read' %}", arrayToAjax(selected_messages, 'message'), function(response_context) {
            for (index = 0; index < selected_messages.length; ++index) {
                $(document.getElementById(selected_messages[index])).removeClass('bg-info');
            };
            set_spinner_status(selected_messages, false);
        });
    };
    function remove_voicemail(message_uid)  {
        // Cannot use JQuery here: $ signs and other character in UUID break the query
        var archive_link = document.getElementById('archive_' + message_uid);
        archive_link.style.display = 'none';
        
        var spinner = document.getElementById('spinner_' + message_uid);
        spinner.style.display = 'block';
        
        ajaxPost("{% url 'remove_voicemail' %}", {"message_uid": message_uid}, function(response_context) {
            var row = document.getElementById('voicemail_' + message_uid);
            row.parentNode.removeChild(row);
        });
    };
</script>
{% endblock %}